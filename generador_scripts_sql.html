<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Scripts SQL - Matesur</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .tabs {
            display: flex;
            background: #f5f5f5;
            border-bottom: 2px solid #ddd;
        }

        .tab {
            flex: 1;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            background: #e0e0e0;
            border: none;
            font-size: 1.1em;
            font-weight: bold;
            transition: all 0.3s;
            color: #333;
        }

        .tab:hover {
            background: #d0d0d0;
        }

        .tab.active {
            background: white;
            color: #667eea;
            border-bottom: 3px solid #667eea;
        }

        .tab-content {
            display: none;
            padding: 30px;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 0.95em;
        }

        input[type="text"],
        input[type="number"],
        input[type="date"],
        select,
        textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            transition: all 0.3s;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            flex-wrap: wrap;
        }

        button {
            flex: 1;
            min-width: 200px;
            padding: 15px 30px;
            font-size: 1.1em;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }

        .preview {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 2px solid #ddd;
        }

        .preview h3 {
            margin-bottom: 15px;
            color: #667eea;
        }

        .preview pre {
            background: #282c34;
            color: #abb2bf;
            padding: 20px;
            border-radius: 8px;
            overflow-x: auto;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.9em;
            line-height: 1.5;
            max-height: 500px;
        }

        .help-text {
            font-size: 0.85em;
            color: #666;
            margin-top: 5px;
            font-style: italic;
        }

        .section-title {
            font-size: 1.3em;
            color: #667eea;
            margin: 25px 0 15px 0;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 768px) {
            .grid-2 {
                grid-template-columns: 1fr;
            }

            .button-group {
                flex-direction: column;
            }

            button {
                min-width: 100%;
            }
        }

        .alert {
            padding: 15px;
            margin: 20px 0;
            border-radius: 8px;
            font-weight: 500;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ Generador de Scripts SQL</h1>
            <p>Herramienta para generar scripts DDL y DML basados en templates est√°ndar</p>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('ddl')">üìù CREATE (DDL)</button>
            <button class="tab" onclick="switchTab('dml')">üîß ALTER (DML)</button>
        </div>

        <!-- TAB DDL -->
        <div id="ddl-content" class="tab-content active">
            <form id="ddl-form">
                <div class="section-title">üìã Informaci√≥n General</div>
                
                <div class="grid-2">
                    <div class="form-group">
                        <label>Requerimiento *</label>
                        <input type="text" id="ddl-req" placeholder="Ej: 3888" required>
                        <div class="help-text">N√∫mero del requerimiento</div>
                    </div>

                    <div class="form-group">
                        <label>Fecha</label>
                        <input type="date" id="ddl-fecha" required>
                    </div>
                </div>

                <div class="form-group">
                    <label>Descripci√≥n del Cambio *</label>
                    <textarea id="ddl-descripcion" placeholder="Ej: Comprobantes IA. Tabla para procesamiento de comprobantes con IA." required></textarea>
                </div>

                <div class="section-title">üóÉÔ∏è Tabla Principal</div>

                <div class="form-group">
                    <label>Nombre de la Tabla *</label>
                    <input type="text" id="ddl-tabla" placeholder="Ej: CuentaBancariaTarjeta" required>
                </div>

                <div class="form-group">
                    <label>Descripci√≥n de la Tabla *</label>
                    <textarea id="ddl-tabla-desc" placeholder="Descripci√≥n breve de la tabla que se crea" required></textarea>
                </div>

                <div class="section-title">üìä Columnas</div>

                <div id="ddl-columnas">
                    <!-- Las columnas se agregar√°n din√°micamente -->
                </div>

                <button type="button" class="btn-secondary" onclick="agregarColumnaDDL()">‚ûï Agregar Columna</button>

                <div class="section-title">üîó Foreign Keys (Opcional)</div>

                <div id="ddl-fks">
                    <!-- Los FKs se agregar√°n din√°micamente -->
                </div>

                <button type="button" class="btn-secondary" onclick="agregarFKDDL()">‚ûï Agregar Foreign Key</button>

                <div class="button-group">
                    <button type="button" class="btn-primary" onclick="generarScriptDDL()">üéØ Generar Script DDL</button>
                    <button type="button" class="btn-secondary" onclick="limpiarFormularioDDL()">üóëÔ∏è Limpiar</button>
                </div>
            </form>

            <div id="ddl-preview" class="preview" style="display: none;">
                <h3>üìÑ Vista Previa del Script</h3>
                <pre id="ddl-preview-content"></pre>
                <button type="button" class="btn-primary" onclick="descargarScriptDDL()">üíæ Descargar Script .sql</button>
            </div>
        </div>

        <!-- TAB DML -->
        <div id="dml-content" class="tab-content">
            <form id="dml-form">
                <div class="section-title">üìã Informaci√≥n General</div>
                
                <div class="grid-2">
                    <div class="form-group">
                        <label>Requerimiento *</label>
                        <input type="text" id="dml-req" placeholder="Ej: 6675" required>
                        <div class="help-text">N√∫mero del requerimiento</div>
                    </div>

                    <div class="form-group">
                        <label>Fecha</label>
                        <input type="date" id="dml-fecha" required>
                    </div>
                </div>

                <div class="form-group">
                    <label>Descripci√≥n del Cambio *</label>
                    <textarea id="dml-descripcion" placeholder="Ej: Update para vencer el token de MatbaWS." required></textarea>
                </div>

                <div class="section-title">üîß Tipo de Operaci√≥n</div>

                <div class="form-group">
                    <label>Operaci√≥n DML *</label>
                    <select id="dml-operacion" onchange="actualizarFormularioDML()" required>
                        <option value="">Seleccione una operaci√≥n...</option>
                        <option value="ALTER_ADD">ALTER TABLE - ADD Column</option>
                        <option value="ALTER_MODIFY">ALTER TABLE - MODIFY Column</option>
                        <option value="UPDATE">UPDATE - Actualizar datos</option>
                        <option value="INSERT">INSERT - Insertar datos</option>
                        <option value="DELETE">DELETE - Eliminar datos</option>
                    </select>
                </div>

                <!-- Campos din√°micos seg√∫n operaci√≥n -->
                <div id="dml-campos-dinamicos"></div>

                <div class="button-group">
                    <button type="button" class="btn-primary" onclick="generarScriptDML()">üéØ Generar Script DML</button>
                    <button type="button" class="btn-secondary" onclick="limpiarFormularioDML()">üóëÔ∏è Limpiar</button>
                </div>
            </form>

            <div id="dml-preview" class="preview" style="display: none;">
                <h3>üìÑ Vista Previa del Script</h3>
                <pre id="dml-preview-content"></pre>
                <button type="button" class="btn-primary" onclick="descargarScriptDML()">üíæ Descargar Script .sql</button>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // FUNCIONES GENERALES
        // ============================================

        function switchTab(tab) {
            // Cambiar tabs activos
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            if (tab === 'ddl') {
                document.querySelectorAll('.tab')[0].classList.add('active');
                document.getElementById('ddl-content').classList.add('active');
            } else {
                document.querySelectorAll('.tab')[1].classList.add('active');
                document.getElementById('dml-content').classList.add('active');
            }
        }

        function formatearFecha(fecha) {
            const d = new Date(fecha);
            const dia = String(d.getDate()).padStart(2, '0');
            const mes = String(d.getMonth() + 1).padStart(2, '0');
            const anio = d.getFullYear();
            return `${dia}/${mes}/${anio}`;
        }

        function descargarArchivo(contenido, nombreArchivo) {
            const blob = new Blob([contenido], { type: 'text/plain;charset=utf-8' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = nombreArchivo;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        // ============================================
        // FUNCIONES DDL
        // ============================================

        let contadorColumnasDDL = 0;
        let contadorFKsDDL = 0;

        function agregarColumnaDDL() {
            contadorColumnasDDL++;
            const contenedor = document.getElementById('ddl-columnas');
            
            const div = document.createElement('div');
            div.className = 'form-group';
            div.style.position = 'relative';
            div.style.border = '2px solid #e0e0e0';
            div.style.padding = '15px';
            div.style.borderRadius = '8px';
            div.style.marginBottom = '15px';
            div.id = `columna-${contadorColumnasDDL}`;
            
            div.innerHTML = `
                <button type="button" onclick="eliminarElemento('columna-${contadorColumnasDDL}')" aria-label="Eliminar columna" title="Eliminar" style="position: absolute; top: 8px; right: 8px; background: linear-gradient(135deg,#e55353,#dc3545); color: white; border: none; padding: 6px 10px; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600; display: inline-flex; align-items: center; justify-content:center; z-index: 2;">Eliminar</button>
                <div style="margin-bottom: 10px;">
                    <strong>Columna #${contadorColumnasDDL}</strong>
                </div>
                <div class="grid-2">
                    <div>
                        <label>Nombre de la Columna</label>
                        <input type="text" name="col-nombre-${contadorColumnasDDL}" placeholder="Ej: CuentaBancariaNombre">
                    </div>
                    <div>
                        <label>Tipo de Dato</label>
                        <div style="display:flex; gap:10px; align-items:center;">
                            <select name="col-tipo-${contadorColumnasDDL}" onchange="actualizarTipoDato(${contadorColumnasDDL})" style="margin-bottom: 0; flex: 1;">
                            <option value="">Seleccione tipo...</option>
                            <optgroup label="Cadenas de Texto">
                                <option value="varchar()">VARCHAR(n) - Texto variable</option>
                                <option value="nvarchar()">NVARCHAR(n) - Texto Unicode</option>
                                <option value="char()">CHAR(n) - Texto fijo</option>
                                <option value="nchar()">NCHAR(n) - Texto fijo Unicode</option>
                                <option value="text">TEXT - Texto largo</option>
                                <option value="ntext">NTEXT - Texto largo Unicode</option>
                            </optgroup>
                            <optgroup label="N√∫meros Enteros">
                                <option value="int">INT - Entero (-2,147,483,648 a 2,147,483,647)</option>
                                <option value="bigint">BIGINT - Entero grande</option>
                                <option value="smallint">SMALLINT - Entero peque√±o</option>
                                <option value="tinyint">TINYINT - Entero muy peque√±o (0-255)</option>
                            </optgroup>
                            <optgroup label="N√∫meros Decimales">
                                <option value="decimal(,)">DECIMAL(p,s) - Decimal exacto</option>
                                <option value="numeric(,)">NUMERIC(p,s) - Num√©rico exacto</option>
                                <option value="money">MONEY - Dinero</option>
                                <option value="smallmoney">SMALLMONEY - Dinero peque√±o</option>
                                <option value="float">FLOAT - Decimal aproximado</option>
                                <option value="real">REAL - Decimal simple</option>
                            </optgroup>
                            <optgroup label="Fecha y Hora">
                                <option value="datetime">DATETIME - Fecha y hora</option>
                                <option value="datetime2">DATETIME2 - Fecha y hora precisa</option>
                                <option value="date">DATE - Solo fecha</option>
                                <option value="time">TIME - Solo hora</option>
                                <option value="smalldatetime">SMALLDATETIME - Fecha y hora simple</option>
                            </optgroup>
                            <optgroup label="Binarios">
                                <option value="bit">BIT - Booleano (0/1)</option>
                                <option value="binary()">BINARY(n) - Binario fijo</option>
                                <option value="varbinary()">VARBINARY(n) - Binario variable</option>
                                <option value="varbinary(max)">VARBINARY(MAX) - Binario grande</option>
                            </optgroup>
                            <optgroup label="Otros">
                                <option value="uniqueidentifier">UNIQUEIDENTIFIER - GUID</option>
                                <option value="xml">XML - Datos XML</option>
                            </optgroup>
                            </select>
                            <input type="text" name="col-tipo-custom-${contadorColumnasDDL}" placeholder="Editar tipo de dato..." style="display: none; flex: 0 0 220px;">
                        </div>
                    </div>
                </div>
                <div>
                    <label>Descripci√≥n de la Columna</label>
                    <textarea name="col-desc-${contadorColumnasDDL}" placeholder="Descripci√≥n breve de la columna"></textarea>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" name="col-null-${contadorColumnasDDL}" id="col-null-${contadorColumnasDDL}">
                    <label for="col-null-${contadorColumnasDDL}">¬øPermite NULL?</label>
                </div>
            `;
            
            contenedor.appendChild(div);
        }

        function agregarFKDDL() {
            contadorFKsDDL++;
            const contenedor = document.getElementById('ddl-fks');
            
            const div = document.createElement('div');
            div.className = 'form-group';
            div.style.position = 'relative';
            div.style.border = '2px solid #e0e0e0';
            div.style.padding = '15px';
            div.style.borderRadius = '8px';
            div.style.marginBottom = '15px';
            div.id = `fk-${contadorFKsDDL}`;
            
            div.innerHTML = `
                <button type="button" onclick="eliminarElemento('fk-${contadorFKsDDL}')" aria-label="Eliminar fk" title="Eliminar" style="position: absolute; top: 8px; right: 8px; background: linear-gradient(135deg,#e55353,#dc3545); color: white; border: none; padding: 6px 10px; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600; display: inline-flex; align-items: center; justify-content:center; z-index: 2;">Eliminar</button>
                <div style="margin-bottom: 10px;">
                    <strong>Foreign Key #${contadorFKsDDL}</strong>
                </div>

                <div class="grid-2">
                    <div>
                        <label>Columna Local</label>
                        <input type="text" name="fk-col-local-${contadorFKsDDL}" placeholder="Ej: F_UsuarioIDTit" oninput="actualizarNombreFK(${contadorFKsDDL})">
                    </div>
                    <div>
                        <label>Tabla Referenciada</label>
                        <input type="text" name="fk-tabla-ref-${contadorFKsDDL}" placeholder="Ej: Usuario" oninput="actualizarNombreFK(${contadorFKsDDL})">
                    </div>
                </div>

                <div class="grid-2">
                    <div>
                        <label>Columna Referenciada</label>
                        <input type="text" name="fk-col-ref-${contadorFKsDDL}" placeholder="Ej: UsuarioID" oninput="actualizarNombreFK(${contadorFKsDDL})">
                    </div>
                    <div>
                        <label>Nombre FK (sugerido)</label>
                        <input type="text" name="fk-nombre-${contadorFKsDDL}" placeholder="Ej: FK_CBTarjeta_Titular" data-manual="false" oninput="this.setAttribute('data-manual','true')">
                    </div>
                </div>
            `;
            
            contenedor.appendChild(div);
        }

        function actualizarTipoDato(id) {
            const select = document.querySelector(`[name="col-tipo-${id}"]`);
            const input = document.querySelector(`[name="col-tipo-custom-${id}"]`);
            
            if (select && input) {
                const valor = select.value;
                input.value = valor;
                input.style.display = 'inline-block';
                input.style.width = '220px';
                
                // Si tiene par√©ntesis, posicionar cursor dentro
                if (valor.includes('(')) {
                    input.focus();
                    const posicion = valor.indexOf('(') + 1;
                    input.setSelectionRange(posicion, posicion);
                }
            }
        }

        function actualizarNombreFK(id) {
            const nombreInput = document.querySelector(`[name="fk-nombre-${id}"]`);
            if (!nombreInput) return;

            // si el usuario ya edit√≥ manualmente, no sobrescribimos
            if (nombreInput.getAttribute('data-manual') === 'true') return;

            const colLocal = (document.querySelector(`[name="fk-col-local-${id}"]`)?.value || '').trim();
            const tablaRef = (document.querySelector(`[name="fk-tabla-ref-${id}"]`)?.value || '').trim();
            const colRef = (document.querySelector(`[name="fk-col-ref-${id}"]`)?.value || '').trim();
            const ddlTabla = (document.getElementById('ddl-tabla')?.value || '').trim();

            let suggested = '';
            if (ddlTabla && colLocal) {
                suggested = `FK_${ddlTabla}_${colLocal}`;
            } else if (tablaRef && colLocal) {
                suggested = `FK_${tablaRef}_${colLocal}`;
            } else if (tablaRef && colRef) {
                suggested = `FK_${tablaRef}_${colRef}`;
            } else if (colLocal) {
                suggested = `FK_${colLocal}`;
            } else if (tablaRef) {
                suggested = `FK_${tablaRef}`;
            } else if (colRef) {
                suggested = `FK_${colRef}`;
            }

            // Normalizar: may√∫sculas y guiones bajos, quitar chars inv√°lidos
            suggested = suggested.toUpperCase().replace(/\s+/g, '_').replace(/[^A-Z0-9_]/g, '');

            if (!suggested) suggested = '';
            nombreInput.value = suggested;
        }

        function eliminarElemento(id) {
            const elemento = document.getElementById(id);
            if (elemento) {
                elemento.remove();
            }
        }

        function generarScriptDDL() {
            const req = document.getElementById('ddl-req').value;
            const fecha = document.getElementById('ddl-fecha').value;
            const descripcion = document.getElementById('ddl-descripcion').value;
            const tabla = document.getElementById('ddl-tabla').value;
            const tablaDesc = document.getElementById('ddl-tabla-desc').value;

            if (!req || !fecha || !descripcion || !tabla || !tablaDesc) {
                alert('‚ö†Ô∏è Por favor complete todos los campos obligatorios');
                return;
            }

            const fechaFormateada = formatearFecha(fecha);

            // Construir script
            let script = `/*
\t[Mat√≠asC] ${fechaFormateada} - Requerimiento ${req}. ${descripcion}
*/

SET NOCOUNT ON
BEGIN TRY
  BEGIN TRANSACTION

\t\t--Crea la Tabla ${tabla}
\t\tIF NOT EXISTS(select * from sys.tables where object_name(object_id) = '${tabla}')
\t\tBEGIN
\t\t\tCREATE TABLE [dbo].[${tabla}](
\t\t\t\t[${tabla}ID] [int] IDENTITY(1,1) NOT NULL,
`;

            // Agregar columnas
            for (let i = 1; i <= contadorColumnasDDL; i++) {
                const nombre = document.querySelector(`[name="col-nombre-${i}"]`)?.value;
                const tipoCustom = document.querySelector(`[name="col-tipo-custom-${i}"]`)?.value;
                const tipoSelect = document.querySelector(`[name="col-tipo-${i}"]`)?.value;
                const tipo = tipoCustom || tipoSelect;
                const permiteNull = document.getElementById(`col-null-${i}`)?.checked;
                
                if (nombre && tipo) {
                    const nullConstraint = permiteNull ? 'NULL' : 'NOT NULL';
                    script += `\t\t\t\t[${nombre}] [${tipo}] ${nullConstraint},\n`;
                }
            }

            // Agregar columnas de auditor√≠a est√°ndar
            script += `\t\t\t\t[FechaAlta] [int] NOT NULL,
\t\t\t\t[F_UsuarioIDAlta] [int] NOT NULL,
\t\t\t\t[FechaUltModif] [int] NOT NULL,
\t\t\t\t[F_UsuarioIDUltModif] [int] NOT NULL,
\t\t\t CONSTRAINT [PK_dbo.${tabla}] PRIMARY KEY CLUSTERED ([${tabla}ID] ASC)
\t\t\t) ON [PRIMARY]

`;

            // Agregar Foreign Keys
            for (let i = 1; i <= contadorFKsDDL; i++) {
                const nombreFK = document.querySelector(`[name="fk-nombre-${i}"]`)?.value;
                const colLocal = document.querySelector(`[name="fk-col-local-${i}"]`)?.value;
                const tablaRef = document.querySelector(`[name="fk-tabla-ref-${i}"]`)?.value;
                const colRef = document.querySelector(`[name="fk-col-ref-${i}"]`)?.value;
                
                if (nombreFK && colLocal && tablaRef && colRef) {
                    script += `\t\t\tALTER TABLE [dbo].[${tabla}] ADD CONSTRAINT [${nombreFK}] FOREIGN KEY([${colLocal}]) REFERENCES [dbo].[${tablaRef}] ([${colRef}])\n\t\t\t\n`;
                }
            }

            // Agregar descripci√≥n de tabla
            script += `\t\t\t--Con la siguiente linea agregamos una descripci√≥n sobre la tabla que estamos creando.
\t\t\tEXEC sys.sp_addextendedproperty 
\t\t\t\t @name=N'MS_Description'
\t\t\t\t,@value=N'${tablaDesc}'
\t\t\t\t,@level0type=N'SCHEMA'
\t\t\t\t,@level0name=N'dbo'
\t\t\t\t,@level1type=N'TABLE'
\t\t\t\t,@level1name=N'${tabla}'
\t\t\t \n`;

            // Agregar descripciones de columnas
            for (let i = 1; i <= contadorColumnasDDL; i++) {
                const nombre = document.querySelector(`[name="col-nombre-${i}"]`)?.value;
                const desc = document.querySelector(`[name="col-desc-${i}"]`)?.value;
                
                if (nombre && desc) {
                    script += `\t\t\t--Con la siguiente linea agregamos una descripci√≥n sobre la columna que estamos creando.
\t\t\tEXEC sys.sp_addextendedproperty 
\t\t\t\t @name=N'MS_Description'
\t\t\t\t,@value=N'${desc}'
\t\t\t\t,@level0type=N'SCHEMA'
\t\t\t\t,@level0name=N'dbo'
\t\t\t\t,@level1type=N'TABLE'
\t\t\t\t,@level1name=N'${tabla}'
\t\t\t\t,@level2type=N'COLUMN'
\t\t\t\t,@level2name=N'${nombre}'

`;
                }
            }

            script += `\t\tEND
\t\t
\tPRINT ' Procesado correctamente'
  COMMIT
END TRY
BEGIN CATCH
\tROLLBACK
\tPRINT ' Error'
\tSELECT ERROR_MESSAGE(),ISNULL(ERROR_PROCEDURE(), '-')
END CATCH
SET NOCOUNT OFF`;

            // Mostrar preview
            document.getElementById('ddl-preview-content').textContent = script;
            document.getElementById('ddl-preview').style.display = 'block';
            document.getElementById('ddl-preview').scrollIntoView({ behavior: 'smooth' });
        }

        function descargarScriptDDL() {
            const contenido = document.getElementById('ddl-preview-content').textContent;
            const req = document.getElementById('ddl-req').value;
            const tabla = document.getElementById('ddl-tabla').value;
            const timestamp = new Date().toISOString().slice(0, 10).replace(/-/g, '');
            const nombreArchivo = `${req}_CREATE_${tabla}_${timestamp}.sql`;
            
            descargarArchivo(contenido, nombreArchivo);
        }

        function limpiarFormularioDDL() {
            document.getElementById('ddl-form').reset();
            document.getElementById('ddl-columnas').innerHTML = '';
            document.getElementById('ddl-fks').innerHTML = '';
            document.getElementById('ddl-preview').style.display = 'none';
            contadorColumnasDDL = 0;
            contadorFKsDDL = 0;
        }

        // ============================================
        // FUNCIONES DML
        // ============================================

        function actualizarFormularioDML() {
            const operacion = document.getElementById('dml-operacion').value;
            const contenedor = document.getElementById('dml-campos-dinamicos');
            
            contenedor.innerHTML = '';

            if (operacion === 'ALTER_ADD') {
                contenedor.innerHTML = `
                    <div class="section-title">‚ûï Agregar Columna</div>
                    <div class="form-group">
                        <label>Nombre de la Tabla *</label>
                        <input type="text" id="dml-tabla" placeholder="Ej: MatexOrden" required>
                    </div>
                    <div class="grid-2">
                        <div class="form-group">
                            <label>Nombre de la Columna *</label>
                            <input type="text" id="dml-columna" placeholder="Ej: ComisionAgente" required>
                        </div>
                        <div class="form-group">
                            <label>Tipo de Dato *</label>
                            <div style="display:flex; gap:10px; align-items:center;">
                                <select id="dml-tipo-select" onchange="actualizarTipoDatoDML()" style="margin-bottom: 0; flex: 1;">
                                <option value="">Seleccione tipo...</option>
                                <optgroup label="Cadenas de Texto">
                                    <option value="varchar()">VARCHAR(n)</option>
                                    <option value="nvarchar()">NVARCHAR(n)</option>
                                    <option value="char()">CHAR(n)</option>
                                    <option value="text">TEXT</option>
                                </optgroup>
                                <optgroup label="N√∫meros Enteros">
                                    <option value="int">INT</option>
                                    <option value="bigint">BIGINT</option>
                                    <option value="smallint">SMALLINT</option>
                                    <option value="tinyint">TINYINT</option>
                                </optgroup>
                                <optgroup label="N√∫meros Decimales">
                                    <option value="decimal(,)">DECIMAL(p,s)</option>
                                    <option value="numeric(,)">NUMERIC(p,s)</option>
                                    <option value="money">MONEY</option>
                                    <option value="float">FLOAT</option>
                                </optgroup>
                                <optgroup label="Fecha y Hora">
                                    <option value="datetime">DATETIME</option>
                                    <option value="datetime2">DATETIME2</option>
                                    <option value="date">DATE</option>
                                    <option value="time">TIME</option>
                                </optgroup>
                                <optgroup label="Otros">
                                    <option value="bit">BIT</option>
                                    <option value="uniqueidentifier">UNIQUEIDENTIFIER</option>
                                    <option value="xml">XML</option>
                                </optgroup>
                            </select>
                            <input type="text" id="dml-tipo" placeholder="Editar tipo de dato..." required style="display: none; flex: 0 0 220px;">
                        </div>
                        </div>
                    </div>
                    <div class="form-group checkbox-group">
                        <input type="checkbox" id="dml-null" checked>
                        <label for="dml-null">¬øPermite NULL?</label>
                    </div>
                `;
            } else if (operacion === 'UPDATE') {
                contenedor.innerHTML = `
                    <div class="section-title">üìù Actualizar Datos</div>
                    <div class="form-group">
                        <label>Nombre de la Tabla *</label>
                        <input type="text" id="dml-tabla" placeholder="Ej: Usuario" required>
                    </div>
                    <div class="form-group">
                        <label>Columnas a actualizar (SET) *</label>
                        <textarea id="dml-set" placeholder="Ej: Estado = 1, Activo = 1" required></textarea>
                        <div class="help-text">Separar m√∫ltiples columnas con comas</div>
                    </div>
                    <div class="form-group">
                        <label>Condici√≥n WHERE *</label>
                        <textarea id="dml-where" placeholder="Ej: UsuarioID = 123" required></textarea>
                    </div>
                `;
            } else if (operacion === 'INSERT') {
                contenedor.innerHTML = `
                    <div class="section-title">‚ûï Insertar Datos</div>
                    <div class="form-group">
                        <label>Nombre de la Tabla *</label>
                        <input type="text" id="dml-tabla" placeholder="Ej: Parametria" required>
                    </div>
                    <div class="form-group">
                        <label>Columnas *</label>
                        <input type="text" id="dml-columnas" placeholder="Ej: Nombre, Valor, Descripcion" required>
                        <div class="help-text">Separar con comas</div>
                    </div>
                    <div class="form-group">
                        <label>Valores *</label>
                        <textarea id="dml-valores" placeholder="Ej: 'Parametro1', 100, 'Descripci√≥n del par√°metro'" required></textarea>
                    </div>
                `;
            } else if (operacion === 'DELETE') {
                contenedor.innerHTML = `
                    <div class="section-title">üóëÔ∏è Eliminar Datos</div>
                    <div class="alert alert-info">
                        ‚ö†Ô∏è PRECAUCI√ìN: Aseg√∫rese de incluir una condici√≥n WHERE espec√≠fica
                    </div>
                    <div class="form-group">
                        <label>Nombre de la Tabla *</label>
                        <input type="text" id="dml-tabla" placeholder="Ej: LogTable" required>
                    </div>
                    <div class="form-group">
                        <label>Condici√≥n WHERE *</label>
                        <textarea id="dml-where" placeholder="Ej: FechaCreacion < '2023-01-01'" required></textarea>
                    </div>
                `;
            }
        }

        function generarScriptDML() {
            const req = document.getElementById('dml-req').value;
            const fecha = document.getElementById('dml-fecha').value;
            const descripcion = document.getElementById('dml-descripcion').value;
            const operacion = document.getElementById('dml-operacion').value;

            if (!req || !fecha || !descripcion || !operacion) {
                alert('‚ö†Ô∏è Por favor complete todos los campos obligatorios');
                return;
            }

            const fechaFormateada = formatearFecha(fecha);
            let script = `/*
\tmcellamare ${fechaFormateada}: ${descripcion}
*/

SET NOCOUNT ON;

BEGIN TRY
`;

            if (operacion === 'ALTER_ADD') {
                const tabla = document.getElementById('dml-tabla').value;
                const columna = document.getElementById('dml-columna').value;
                const tipo = document.getElementById('dml-tipo').value;
                const permiteNull = document.getElementById('dml-null').checked;

                if (!tabla || !columna || !tipo) {
                    alert('‚ö†Ô∏è Complete todos los campos');
                    return;
                }

                const nullConstraint = permiteNull ? 'NULL' : 'NOT NULL';

                script += `
    -- Verificar si la columna ya existe antes de modificar la tabla
    IF NOT EXISTS (
        SELECT * 
        FROM sys.columns 
        WHERE object_id = OBJECT_ID('${tabla}') 
          AND name = '${columna}'
    )
    BEGIN
        BEGIN TRANSACTION;

        ALTER TABLE ${tabla}
            ADD ${columna} ${tipo} ${nullConstraint};

        PRINT 'Columna ${columna} agregada correctamente.';

        COMMIT;
    END
    ELSE
    BEGIN
        PRINT 'La columna ${columna} ya existe.';
    END
`;
            } else if (operacion === 'UPDATE') {
                const tabla = document.getElementById('dml-tabla').value;
                const set = document.getElementById('dml-set').value;
                const where = document.getElementById('dml-where').value;

                if (!tabla || !set || !where) {
                    alert('‚ö†Ô∏è Complete todos los campos');
                    return;
                }

                script += `
    BEGIN TRANSACTION;

    UPDATE ${tabla}
    SET ${set}
    WHERE ${where};

    PRINT '‚úÖ Actualizaci√≥n completada correctamente.';
    PRINT '   Registros afectados: ' + CAST(@@ROWCOUNT AS VARCHAR);

    COMMIT;
`;
            } else if (operacion === 'INSERT') {
                const tabla = document.getElementById('dml-tabla').value;
                const columnas = document.getElementById('dml-columnas').value;
                const valores = document.getElementById('dml-valores').value;

                if (!tabla || !columnas || !valores) {
                    alert('‚ö†Ô∏è Complete todos los campos');
                    return;
                }

                script += `
    BEGIN TRANSACTION;

    INSERT INTO ${tabla} (${columnas})
    VALUES (${valores});

    PRINT '‚úÖ Registro insertado correctamente.';
    PRINT '   Nuevo ID: ' + CAST(SCOPE_IDENTITY() AS VARCHAR);

    COMMIT;
`;
            } else if (operacion === 'DELETE') {
                const tabla = document.getElementById('dml-tabla').value;
                const where = document.getElementById('dml-where').value;

                if (!tabla || !where) {
                    alert('‚ö†Ô∏è Complete todos los campos');
                    return;
                }

                script += `
    BEGIN TRANSACTION;

    DELETE FROM ${tabla}
    WHERE ${where};

    PRINT '‚úÖ Registros eliminados correctamente.';
    PRINT '   Registros afectados: ' + CAST(@@ROWCOUNT AS VARCHAR);

    COMMIT;
`;
            }

            script += `
END TRY
BEGIN CATCH
    IF @@TRANCOUNT > 0
        ROLLBACK;

    PRINT 'Error al procesar la operaci√≥n.';
    SELECT ERROR_MESSAGE() AS MensajeError, ISNULL(ERROR_PROCEDURE(), '-') AS Procedimiento;
END CATCH

SET NOCOUNT OFF;`;

            // Mostrar preview
            document.getElementById('dml-preview-content').textContent = script;
            document.getElementById('dml-preview').style.display = 'block';
            document.getElementById('dml-preview').scrollIntoView({ behavior: 'smooth' });
        }

        function descargarScriptDML() {
            const contenido = document.getElementById('dml-preview-content').textContent;
            const req = document.getElementById('dml-req').value;
            const operacion = document.getElementById('dml-operacion').value;
            const timestamp = new Date().toISOString().slice(0, 10).replace(/-/g, '');
            const nombreArchivo = `${req}_${operacion}_${timestamp}.sql`;
            
            descargarArchivo(contenido, nombreArchivo);
        }

        function actualizarTipoDatoDML() {
            const select = document.getElementById('dml-tipo-select');
            const input = document.getElementById('dml-tipo');
            
            if (select && input) {
                const valor = select.value;
                input.value = valor;
                input.style.display = 'inline-block';
                input.style.width = '220px';
                
                // Si tiene par√©ntesis, posicionar cursor dentro
                if (valor.includes('(')) {
                    input.focus();
                    const posicion = valor.indexOf('(') + 1;
                    input.setSelectionRange(posicion, posicion);
                }
            }
        }

        function limpiarFormularioDML() {
            document.getElementById('dml-form').reset();
            document.getElementById('dml-campos-dinamicos').innerHTML = '';
            document.getElementById('dml-preview').style.display = 'none';
        }

        // ============================================
        // INICIALIZACI√ìN
        // ============================================

        window.onload = function() {
            // Establecer fecha actual
            const hoy = new Date().toISOString().split('T')[0];
            document.getElementById('ddl-fecha').value = hoy;
            document.getElementById('dml-fecha').value = hoy;

            // Agregar primera columna por defecto en DDL
            agregarColumnaDDL();
        };
    </script>
</body>
</html>